<?xml version="1.0" encoding="US-ASCII" ?>
<!--
 -*- mode: Fundamental; tab-width: 4; -*-
 ex:ts=4

 $Id$

 Transforms a single XML file using XSLT to bootstrap the build process for a
 XINS project. Then it actually instructs Ant to process the generated XML
 file.
-->

<project name="xins-bootstrap-ant" default="run" basedir=".">

	<target name="run" depends="make-build">
		<taskdef name="calltargets" classname="org.xins.common.ant.CallTargetsTask" classpath="${xins_home}/build/xins-common.jar" />
		<calltargets antfile="${project_home}/build/build.xml" targets="${args}" dir="${pwd}"/>
	</target>

	<target name="make-build">
		<property name="project_home" location="${user.dir}" />

		<available file="${xins_home}/src/xslt/xins-project_to_ant-build.xslt"
		           property="ant.build.xslt.exists" />
		<fail message="Cannot find stylesheet" unless="ant.build.xslt.exists" />

		<available file="${project_home}/xins-project.xml"
		           property="xins-project.xml.exists" />
		<fail message="Cannot find input file xins-project.xml" unless="xins-project.xml.exists" />

		<mkdir dir="${project_home}/build" />

		<property file="${xins_home}/.version.properties" />
		<property name="version" value="${version.major}.${version.middle}.${version.minor}${version.build}${version.suffix}" />
		<dependset>
			<srcfileset    file="${xins_home}/.version.properties"                 />
			<srcfileset    dir="${project_home}"    includes="**/api.xml"          />
			<srcfileset    dir="${project_home}"    includes="**/impl.xml"         />
			<srcfileset    dir="${project_home}"    includes="**/environments.xml" />
			<targetfileset file="${project_home}/build/build.xml" />
		</dependset>
		<style in="${project_home}/xins-project.xml"
		       out="${project_home}/build/build.xml"
		       style="${xins_home}/src/xslt/xins-project_to_ant-build.xslt">
			<xmlcatalog>
				<dtd publicId="-//XINS//DTD XINS Project 1.0 alpha//EN"
				     location="${xins_home}/src/dtd/xins-project_1_0_alpha.dtd" />
				<dtd publicId="-//XINS//DTD XINS API 1.0 alpha//EN"
				     location="${xins_home}/src/dtd/api_1_0_alpha.dtd" />
				<dtd publicId="-//XINS//DTD Function 1.0 alpha//EN"
				     location="${xins_home}/src/dtd/function_1_0_alpha.dtd" />
				<dtd publicId="-//XINS//DTD Type 1.0 alpha//EN"
				     location="${xins_home}/src/dtd/type_1_0_alpha.dtd" />
				<dtd publicId="-//XINS//DTD Result Code 1.0 alpha//EN"
				     location="${xins_home}/src/dtd/resultcode_1_0_alpha.dtd" />

				<dtd publicId="-//XINS//DTD XINS Project 1.0//EN"
				     location="${xins_home}/src/dtd/xins-project_1_0.dtd" />
				<dtd publicId="-//XINS//DTD XINS API 1.0//EN"
				     location="${xins_home}/src/dtd/api_1_0.dtd" />
				<dtd publicId="-//XINS//DTD Function 1.0//EN"
				     location="${xins_home}/src/dtd/function_1_0.dtd" />
				<dtd publicId="-//XINS//DTD Type 1.0//EN"
				     location="${xins_home}/src/dtd/type_1_0.dtd" />
				<dtd publicId="-//XINS//DTD Result Code 1.0//EN"
				     location="${xins_home}/src/dtd/resultcode_1_0.dtd" />
				<dtd publicId="-//XINS//DTD Implementation 1.0//EN"
				     location="${xins_home}/src/dtd/impl_1_0.dtd" />
				<dtd publicId="-//XINS//DTD Environments 1.0//EN"
				     location="${xins_home}/src/dtd/environments_1_0.dtd" />
				<dtd publicId="-//XINS//DTD XINS Logdoc 1.0//EN"
				     location="${xins_home}/src/dtd/log_1_0.dtd" />

				<dtd publicId="-//XINS//DTD XINS Project 1.1//EN"
				     location="${xins_home}/src/dtd/xins-project_1_1.dtd" />
				<dtd publicId="-//XINS//DTD XINS API 1.1//EN"
				     location="${xins_home}/src/dtd/api_1_1.dtd" />
				<dtd publicId="-//XINS//DTD Function 1.1//EN"
				     location="${xins_home}/src/dtd/function_1_1.dtd" />
				<dtd publicId="-//XINS//DTD Type 1.1//EN"
				     location="${xins_home}/src/dtd/type_1_1.dtd" />
				<dtd publicId="-//XINS//DTD Result Code 1.1//EN"
				     location="${xins_home}/src/dtd/resultcode_1_1.dtd" />
				<dtd publicId="-//XINS//DTD Implementation 1.1//EN"
				     location="${xins_home}/src/dtd/impl_1_1.dtd" />
				<dtd publicId="-//XINS//DTD Environments 1.1//EN"
				     location="${xins_home}/src/dtd/environments_1_1.dtd" />
				<dtd publicId="-//XINS//DTD XINS Logdoc 1.1//EN"
				     location="${xins_home}/src/dtd/log_1_1.dtd" />

				<dtd publicId="-//XINS//DTD XINS Project 1.2//EN"
				     location="${xins_home}/src/dtd/xins-project_1_2.dtd" />
				<dtd publicId="-//XINS//DTD XINS API 1.2//EN"
				     location="${xins_home}/src/dtd/api_1_2.dtd" />
				<dtd publicId="-//XINS//DTD Function 1.2//EN"
				     location="${xins_home}/src/dtd/function_1_2.dtd" />
				<dtd publicId="-//XINS//DTD Type 1.2//EN"
				     location="${xins_home}/src/dtd/type_1_2.dtd" />
				<dtd publicId="-//XINS//DTD Result Code 1.2//EN"
				     location="${xins_home}/src/dtd/resultcode_1_2.dtd" />
				<dtd publicId="-//XINS//DTD Implementation 1.2//EN"
				     location="${xins_home}/src/dtd/impl_1_2.dtd" />
				<dtd publicId="-//XINS//DTD Environments 1.2//EN"
				     location="${xins_home}/src/dtd/environments_1_2.dtd" />
				<dtd publicId="-//XINS//DTD XINS Logdoc 1.2//EN"
				     location="${xins_home}/src/dtd/log_1_2.dtd" />
			</xmlcatalog>
			<param name="xins_home"    expression="${xins_home}"    />
			<param name="project_home" expression="${project_home}" />
			<param name="builddir"     expression="build"     />
			<param name="xins_version" expression="${version}"     />
		</style>

	</target>

	<target name="transform">
		<property file="${xins_home}/.version.properties" />
		<property name="version" value="${version.major}.${version.minor}${version.suffix}" />
		<dependset>
			<srcfileset    file="${xins_home}/.version.properties"         />
			<srcfileset    dir="${project_home}"    includes="**/api.xml"  />
			<srcfileset    dir="${project_home}"    includes="**/impl.xml" />
			<targetfileset file="${out}" />
		</dependset>
		<style in="${in}" out="${out}" style="${style}">
			<param name="xins_home"    expression="${xins_home}"    />
			<param name="project_home" expression="${project_home}" />
			<param name="builddir"     expression="${builddir}"     />
			<param name="xins_version" expression="${version}"     />
		</style>
	</target>
</project>
